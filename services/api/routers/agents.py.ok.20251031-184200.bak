# services/api/routers/agents.py
from fastapi import APIRouter, UploadFile, File, Form, HTTPException
from fastapi.responses import JSONResponse
from typing import Dict, Any, Optional
import pandas as pd
import io, json

router = APIRouter()

# ── Import your concrete runners (stubs provided if missing)
try:
    from agents.asset_appraisal.runner import run as run_asset_appraisal  # noqa
except Exception:
    def run_asset_appraisal(df: pd.DataFrame, form_fields: Dict[str, Any]) -> pd.DataFrame:
        out = df.copy()
        if "market_value" in out.columns:
            out["ai_adjusted"] = out["market_value"]
        out["confidence"] = 80.0
        out["market_delta"] = 0.0
        return out

try:
    from agents.credit_appraisal.runner import run as run_credit_appraisal  # noqa
except Exception:
    def run_credit_appraisal(df: pd.DataFrame, form_fields: Dict[str, Any]) -> pd.DataFrame:
        out = df.copy()
        out["decision"] = "approved"
        out["confidence"] = 75.0
        return out

AGENT_REGISTRY: Dict[str, Dict[str, Any]] = {
    "asset_appraisal": {
        "id": "asset_appraisal",
        "display_name": "Asset Appraisal Agent",
        "aliases": ["asset"],
        "runner": run_asset_appraisal,
    },
    "credit_appraisal": {
        "id": "credit_appraisal",
        "display_name": "Credit Appraisal Agent",
        "aliases": ["credit"],
        "runner": run_credit_appraisal,
    },
}

_ALIAS_TO_CANON: Dict[str, str] = {}
for canon, meta in AGENT_REGISTRY.items():
    _ALIAS_TO_CANON[canon] = canon
    for al in meta.get("aliases", []):
        _ALIAS_TO_CANON[al] = canon

def _canonicalize(agent_id: str) -> str:
    cid = _ALIAS_TO_CANON.get(agent_id)
    if not cid:
        raise HTTPException(status_code=404, detail=f"Unknown agent '{agent_id}'")
    return cid

def _read_csv_from_upload(upload: UploadFile) -> pd.DataFrame:
    raw = upload.file.read()
    try:
        return pd.read_csv(io.BytesIO(raw))
    except Exception as e:
        raise HTTPException(status_code=400, detail=f"CSV parse error: {e}") from e

@router.get("/v1/agents")
def list_agents():
    items = []
    for meta in AGENT_REGISTRY.values():
        items.append({
            "id": meta["id"],
            "display_name": meta.get("display_name", meta["id"]),
            "aliases": meta.get("aliases", []),
        })
    return {"agents": items}

@router.get("/v1/agents/list")
def list_agents_alt():
    return list_agents()

@router.post("/v1/agents/{agent_id}/run")
async def run_agent(
    agent_id: str,
    file: UploadFile = File(..., description="CSV file"),
    use_llm: Optional[str] = Form(None),
    llm: Optional[str] = Form(None),
    flavor: Optional[str] = Form(None),
    selected_model: Optional[str] = Form(None),
    agent_name: Optional[str] = Form(None),
    rule_mode: Optional[str] = Form(None),
    max_dti: Optional[str] = Form(None),
    min_ndi_ratio: Optional[str] = Form(None),
    min_emp: Optional[str] = Form(None),
    min_hist: Optional[str] = Form(None),
    max_delin: Optional[str] = Form(None),
    req_min: Optional[str] = Form(None),
    req_max: Optional[str] = Form(None),
    allowed_terms: Optional[str] = Form(None),
    monthly_relief: Optional[str] = Form(None),
):
    canon = _canonicalize(agent_id)
    df = _read_csv_from_upload(file)
    fields = {
        "use_llm": use_llm, "llm": llm, "flavor": flavor,
        "selected_model": selected_model, "agent_name": agent_name,
        "rule_mode": rule_mode, "max_dti": max_dti, "min_ndi_ratio": min_ndi_ratio,
        "min_emp": min_emp, "min_hist": min_hist, "max_delin": max_delin,
        "req_min": req_min, "req_max": req_max,
        "allowed_terms": allowed_terms, "monthly_relief": monthly_relief,
        "agent_id": canon,
    }
    runner = AGENT_REGISTRY[canon]["runner"]
    out_df = runner(df, fields)
    if not isinstance(out_df, pd.DataFrame):
        raise HTTPException(status_code=500, detail="Runner did not return a DataFrame")
    return JSONResponse(content=json.loads(out_df.to_json(orient="records")))
